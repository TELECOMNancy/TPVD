<!DOCTYPE html>
<meta charset="utf-8">
<title>Noeuds-liens radial</title>
<style>

.node circle {
  fill: #999;
}

.node text {
  font: 10px sans-serif;
}

.node--internal text {
  text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
}

.link {
  fill: none;
  stroke: #555;
  stroke-opacity: 0.4;
  stroke-width: 1.5px;
}

.ghost {
   opacity: 0.2;
}

nav ul {
    list-style: none;
    padding:0;
    display: flex;
    flex-wrap: wrap;
}

nav ul li {
    background: #ddd;
    padding:3px 6px;
    margin: 0 5px;
    border-radius: 10px;
}

nav ul li a {
    text-decoration: none;
    cursor: pointer;
}
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
    <nav>
        <ul>
            <li><a href="indexImbrique.html">Cercles imbriqués</a></li>
            <li><a href="indexImbriqueNest.html">Cercles imbriqués selon les attributs</a></li>
            <li><a href="IndexIcicle.html">Glaçons</a></li>
            <li><a href="IndexRadial.html">Noeuds-liens radial</a></li>
            <li><a href="indexRadialNest.html">Noeuds-liens radial selon la médiane des attributs</a></li>
            <li><a href="indexTreemap.html">Treemap</a></li>
            <li><a href="indexExo2.html">Coordonnées parallèles</a></li>
        </ul>
    </nav>
    <header><h1>TP - Bryan Colle et Ali Daoudi</h1>
        <div class="scale">
            <svg id="scale-svg"></svg>
            <p>Radial avec hiérarchies par rapport à : Conférence/Division/Equipe, la couleur et le rayon des cercles des joueurs dépendent du quantile de l'attribut sélectionné.</p>
            <button onclick="ghostLow()">Mettre en évidence les 10 meilleurs</button>
            <button onclick="unghostAll()">Réinitialiser</button>
            <select name="attribute" id="attribute-selection" onchange="changeAttribute(this)">
                <option value="Points" selected>Points</option>
                <option disabled>-----------</option>
                <option value="2 Point Percentage">2 Point Percentage</option>
                <option value="2 Points Attempted">2 Points Attempted</option>
                <option value="2 Points Attempted/Game">2 Points Attempted/Game</option>
                <option value="2 Points Made">2 Points Made</option>
                <option value="2 Points Made/Game">2 Points Made/Game</option>
                <option value="3 Point Percentage">3 Point Percentage</option>
                <option value="3 Points Attempted">3 Points Attempted</option>
                <option value="3 Points Attempted/Game">3 Points Attempted/Game</option>
                <option value="3 Points Made">3 Points Made</option>
                <option value="3 Points Made/Game">3 Points Made/Game</option>
                <option value="Adjusted Field Goal Percentage">Adjusted Field Goal Percentage</option>
                <option value="Assists">Assists</option>
                <option value="Assists/Game">Assists/Game</option>
                <option value="Assists/Turnovers Ratio">Assists/Turnovers Ratio</option>
                <option value="Blocks">Blocks</option>
                <option value="Blocks/Game">Blocks/Game</option>
                <option value="Defensive Rebounds">Defensive Rebounds</option>
                <option value="Defensive Rebounds/Game">Defensive Rebounds/Game</option>
                <option value="Field Goal Percentage">Field Goal Percentage</option>
                <option value="Field Goals Attempted">Field Goals Attempted</option>
                <option value="Field Goals Attempted/Game">Field Goals Attempted/Game</option>
                <option value="Field Goals Made">Field Goals Made</option>
                <option value="Field Goals Made/Game">Field Goals Made/Game</option>
                <option value="Free Throw Percentage">Free Throw Percentage</option>
                <option value="Free Throws Attempted">Free Throws Attempted</option>
                <option value="Free Throws Attempted/Game">Free Throws Attempted/Game</option>
                <option value="Free Throws Made">Free Throws Made</option>
                <option value="Free Throws Made/Game">Free Throws Made/Game</option>
                <option value="Games Played">Games Played</option>
                <option value="Games Started">Games Started</option>
                <option value="Minutes">Minutes</option>
                <option value="Minutes/Game">Minutes/Game</option>
                <option value="Offensive Rebounds">Offensive Rebounds</option>
                <option value="Offensive Rebounds/Game">Offensive Rebounds/Game</option>
                <option value="Personal Fouls">Personal Fouls</option>
                <option value="Personal Fouls/Game">Personal Fouls/Game</option>
                <option value="Player">Player</option>
                <option value="Points/Game">Points/Game</option>
                <option value="Points/Shot">Points/Shot</option>
                <option value="Steals">Steals</option>
                <option value="Steals/Game">Steals/Game</option>
                <option value="Technical Fouls">Technical Fouls</option>
                <option value="Technical Fouls/Game">Technical Fouls/Game</option>
                <option value="Total Rebounds">Total Rebounds</option>
                <option value="Total Rebounds/Game">Total Rebounds/Game</option>
                <option value="Turnovers">Turnovers</option>
                <option value="Turnovers/Game">Turnovers/Game</option>
            </select>
        </div>
    </header>

    <script src="makeScale.js"></script>

<svg class="graph" width="1600" height="1600"></svg>
<script>
    var svg = {};
    var pointsValues = {};
    var maxValue;
        var svgElem = d3.select("svg.graph"),
            width = +svgElem.attr("width"),
            height = +svgElem.attr("height"),
            g = svgElem.append("g").attr("transform", "translate(" + (width / 2) + "," + (height / 2) + ")");

        var tree = d3.tree()
            .size([360, 680])
            .separation(function (a, b) { return (a.parent == b.parent ? 1 : 2) / a.depth; });

        d3.tsv("nba-no-hierarchy.txt", function (error, root) {
            if (error) throw error;

            root = d3.stratify()
                .id(function (d) { return d.Player; })
                .parentId(function (d) { return d.Team; })
                (root);
            var values = [];
            root = d3.hierarchy(root)
                .sum(function (d) {
                    if (d.data.Points !== undefined)
                        values.push(d.data.Points);
                    return d.data.Points;
                })
                .sort(function (a, b) { return b.value - a.value; });
            var color = makeQuantileScale(values);
            root = tree(root);

            svg = {values : values, nodes: root.descendants()};
            pointsValues = values;
            
            maxValue = pointsValues.sort(function(a,b){return b-a;})[0];

            var link = g.selectAll(".link")
                .data(root.descendants().slice(1))
                .enter().append("path")
                .attr("class", function (d) { return "link " + escapeString(d.parent.data.id) + "-" + escapeString(d.data.id) })
                .attr("d", function (d) {
                    return "M" + project(d.x, d.y)
                        + "C" + project(d.x, (d.y + d.parent.y) / 2)
                        + " " + project(d.parent.x, (d.y + d.parent.y) / 2)
                        + " " + project(d.parent.x, d.parent.y);
                });

            var node = g.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", function (d) { return escapeString(d.data.id) + " node" + (d.children ? " node--internal" : " node--leaf parent-" + escapeString(d.parent.data.id)); })
                .attr("transform", function (d) { return "translate(" + project(d.x, d.y) + ")"; });

            node.append("circle")
                .attr("r", function(d) { return d.children ? 3 : 8*(d.value/maxValue); })
                .style("fill", function (d) { return d.children ? undefined : color(d.value); });

            node.append("text")
                .attr("dy", ".31em")
                .attr("x", function (d) { return d.x < 180 === !d.children ? 6 : -6; })
                .style("text-anchor", function (d) { return d.x < 180 === !d.children ? "start" : "end"; })
                .attr("transform", function (d) { return "rotate(" + (d.x < 180 ? d.x - 90 : d.x + 90) + ")"; })
                .text(function (d) { return d.data.id; });
        });

    function ghostLow() { // 1892 is the limit to use to highlight 10 best points
        svg.nodes
            .filter(function (d) { return d.data.data.Points < 1892 && d.depth === 4; }) // Hide all the circles below the tenth score
            .forEach(function(d,i) {
                d3.selectAll(".parent-"+escapeString(d.parent.data.id)+"."+escapeString(d.data.id))
                    .classed("ghost", true);
            }
        );
    }

    function unghostAll() {
        d3.selectAll(".ghost").classed("ghost", false);
    }

    function makeQuantileScale(values) {
        return d3.scaleQuantile()
            .domain(values)
            .range(["#5e4fa2", "#3288bd", "#66c2a5", "#abdda4", "#e6f598", "#fee08b", "#fdae61", "#f46d43", "#d53e4f", "#9e0142"])
    }

    function project(x, y) {
        var angle = (x - 90) / 180 * Math.PI, radius = y;
        return [radius * Math.cos(angle), radius * Math.sin(angle)];
    }

    function escapeString(str) {
        return str.replace(/[^a-zA-Z]/g, '_')
    }

    function changeAttribute(selector) {
        var attribute = selector.value;
        svg.values = [];
        svg.nodes.forEach(function(d,i) {
            svg.values.push(d.data.data[attribute]);
            d.value = d.data.data[attribute];
        })
        maxValue = svg.values.sort(function(a,b){return b-a;})[0];

        var quantile = makeQuantileScale(svg.values);
        svg.nodes.filter(function(d) { return !d.children; }).forEach(function(d,i) {
            d3.select(".parent-"+escapeString(d.parent.data.id)+"."+escapeString(d.data.id) + " > circle")
                .attr("r", function(d) { return d.children ? 3 : 8*(d.value/maxValue); })
                .attr("style", null)
                .style("fill", quantile(d.value));
        });
           // .attr("fill", function(d) { quantile(d.value)});
    }
</script>